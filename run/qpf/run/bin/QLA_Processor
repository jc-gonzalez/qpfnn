#!/bin/bash
##############################################################################
# QLA_Processor
# Driver script for EUCLID QLA Processor (python)
#-----------------------------------------------------------------------------
# Usage:  QLA_Processor {cfgFile}
##############################################################################

VERSION=1.1

# Set I/O directories and files
baseScriptName=${BASH_SOURCE##*/}

usage() {
    echo "Usage: $baseScriptName {cfgFile}"
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

cfgFile=$1
workDir=$(dirname $cfgFile)

cd ${workDir}

binPath=/qlabin
inPath=${workDir}/in
outPath=${workDir}/out

in=$(find ${inPath} -name "*.fits" -print)
id=$(basename $in .fits)

idres=$(echo $id|sed -e 's#LE1_VIS#QLA_LE1-VIS#g')
idlog=$(echo $id|sed -e 's#LE1_VIS#QLA_LE1-VIS#g')

exe=driver.py
results=${outPath}/${idres}.json
log=${outPath}/${idlog}.log
chk=${outPath}/${idlog}.chk

bpm="${binPath}/config/bpm.fits"
satmap="${binPath}/config/vis_sat_map.fits"

visbpm="--vis_bpm ${bpm}"
vissatmap="--vis_sat_map_fits ${satmap}"
chks="--checks_file ${chk}"
interm="--intermediate_products"

#addopts="${visbpm} ${vissatmap} ${interm} ${chks}"
addopts="${visbpm} ${vissatmap}"
#addopts=""

# Run the processor

cd ${workDir}
python ${binPath}/${exe} \
       -i ${inPath} \
       -r ${results} \
       ${addopts} \
       -v 1>${log} 2>&1

# Compress results (can be large)

#if [ -n "${results}" ]; then
#    gzip ${results}
#fi

chown -hR --reference=${cfgFile} ${workDir}
